<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recuperar Contraseña</title>
  <link rel="stylesheet" href="css/auth.css">
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h1>Recuperar contraseña</h1>
      </div>
      <div class="card-body">
        <div id="msg" class="message"></div>

        <!-- Paso 1: Solicitar correo -->
        <div id="step1">
          <div class="step-title">1) Ingresa tu correo</div>
          <form id="formSendMail">
            <div class="form-group">
              <label for="correo">Correo</label>
              <input id="correo" type="email" required placeholder="tu.correo@universidad.edu">
            </div>
            <button class="btn btn-primary" type="submit">Enviar enlace</button>
          </form>
          <div class="helper">¿Ya tienes el enlace? Continúa al paso 2</div>
        </div>

        <!-- Paso 2: Token + nueva contraseña -->
        <div id="step2" style="display:none;">
          <div class="step-title">2) Pega el enlace (token) y crea tu contraseña</div>
          <form id="formReset">
            <div class="form-group">
              <label for="token">Token del enlace</label>
              <input id="token" type="text" required placeholder="Pega aquí el token del enlace de tu correo">
            </div>
            <div class="form-group">
              <label for="pass">Nueva contraseña</label>
              <input id="pass" type="password" minlength="6" required placeholder="••••••••">
            </div>
            <div class="form-group">
              <label for="pass2">Confirmar contraseña</label>
              <input id="pass2" type="password" minlength="6" required placeholder="••••••••">
            </div>
            <button class="btn btn-primary" type="submit">Restablecer</button>
          </form>
          <div class="helper"><a href="/login.html">Volver al login</a></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const msg = document.getElementById('msg');
    function show(type, text){ msg.className = `message ${type}`; msg.textContent = text; msg.style.display = 'block'; }

    const urlParams = new URLSearchParams(window.location.search);
    const preToken = urlParams.get('token');
    if (preToken) { document.getElementById('step1').style.display = 'none'; document.getElementById('step2').style.display = 'block'; document.getElementById('token').value = preToken; }

    // Paso 1: enviar correo
    document.getElementById('formSendMail').addEventListener('submit', async (e) => {
      e.preventDefault();
      const correo = document.getElementById('correo').value;
      try {
        const res = await fetch('/api/forgot-password', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ correo }) });
        const data = await res.json();
        if(res.ok){
          show('success', data.message || 'Se envió un correo con instrucciones');
          document.getElementById('step1').style.display = 'none';
          document.getElementById('step2').style.display = 'block';
        } else {
          show('error', data.message || 'No se pudo enviar el correo');
        }
      } catch(err){ show('error','Error de conexión'); }
    });

    // Paso 2: resetear
    document.getElementById('formReset').addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = document.getElementById('token').value.trim();
      const pass = document.getElementById('pass').value;
      const pass2 = document.getElementById('pass2').value;
      if(pass !== pass2){ show('error','Las contraseñas no coinciden'); return; }
      try {
        const res = await fetch('/api/reset-password', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token, contrasenia: pass }) });
        const data = await res.json();
        if(res.ok){ show('success','Contraseña restablecida. Redirigiendo...'); setTimeout(()=>{ window.location.href = '/login.html'; }, 1500); }
        else { show('error', data.message || 'No se pudo restablecer'); }
      } catch(err){ show('error','Error de conexión'); }
    });
  </script>
</body>
</html>
